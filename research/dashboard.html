<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Codex Quant â€” Research Lab</title>
<style>
:root{--bg:#0d1117;--card:#161b22;--border:#30363d;--text:#c9d1d9;--text2:#8b949e;--accent:#58a6ff;--green:#3fb950;--red:#f85149;--orange:#d29922;--purple:#a371f7}
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:'SF Mono','Fira Code',monospace;background:var(--bg);color:var(--text);padding:16px}
h1{font-size:1.15em;color:var(--accent);margin-bottom:12px;display:flex;align-items:center;gap:8px}
h1 .status{width:10px;height:10px;border-radius:50%;background:var(--red)}
h1 .status.on{background:var(--green);box-shadow:0 0 6px var(--green)}
.grid{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:16px}
@media(max-width:900px){.grid{grid-template-columns:1fr}}
.card{background:var(--card);border:1px solid var(--border);border-radius:8px;padding:14px}
.card h2{font-size:0.85em;color:var(--text2);margin-bottom:8px;text-transform:uppercase;letter-spacing:1px}
.metric{display:inline-block;margin:4px 8px 4px 0;padding:4px 10px;border-radius:4px;font-size:0.82em}
.metric.good{background:#1b3a2c;color:var(--green)}
.metric.bad{background:#3a1b1b;color:var(--red)}
.metric.neutral{background:#2a2a1b;color:var(--orange)}
.metric.info{background:#1b2a3a;color:var(--accent)}
.finding{border-left:3px solid var(--accent);padding:10px 14px;margin:6px 0;background:rgba(88,166,255,0.05);border-radius:0 6px 6px 0;transition:all .2s}
.finding:hover{background:rgba(88,166,255,0.1)}
.finding .title{font-weight:600;color:var(--text);margin-bottom:4px;font-size:0.9em}
.finding .detail{font-size:0.78em;color:var(--text2);white-space:pre-wrap}
.finding .improvement{font-size:0.85em;font-weight:700}
.finding .improvement.pos{color:var(--green)}
.finding .improvement.neg{color:var(--red)}
.finding .badge{display:inline-block;padding:2px 6px;border-radius:3px;font-size:0.7em;margin-left:6px}
.finding .badge.high{background:var(--green);color:#000}
.finding .badge.med{background:var(--orange);color:#000}
.finding .badge.low{background:var(--text2);color:#000}
.progress-bar{height:4px;background:var(--border);border-radius:2px;margin:8px 0}
.progress-bar .fill{height:100%;background:var(--accent);border-radius:2px;transition:width .5s}
table{width:100%;border-collapse:collapse;font-size:0.8em;margin-top:8px}
th{text-align:left;color:var(--text2);border-bottom:1px solid var(--border);padding:6px 8px}
td{padding:5px 8px;border-bottom:1px solid rgba(48,54,61,0.4)}
.regime-chip{display:inline-block;padding:2px 8px;border-radius:10px;font-size:0.72em;font-weight:600}
.regime-chip.bull{background:#1b3a2c;color:var(--green)}
.regime-chip.bear{background:#3a1b1b;color:var(--red)}
.regime-chip.chop{background:#2a2a1b;color:var(--orange)}
.regime-chip.volatile{background:#2a1b3a;color:var(--purple)}
#log{max-height:200px;overflow-y:auto;font-size:0.72em;color:var(--text2);background:rgba(0,0,0,0.3);padding:8px;border-radius:4px;margin-top:8px}
.sweep-stage{display:flex;align-items:center;gap:8px;margin:4px 0;font-size:0.8em}
.sweep-stage .name{min-width:140px;color:var(--text2)}
.sweep-stage .bar{flex:1;height:6px;background:var(--border);border-radius:3px;overflow:hidden}
.sweep-stage .bar-fill{height:100%;border-radius:3px;transition:width .3s}
.sweep-stage .bar-fill.done{background:var(--green)}
.sweep-stage .bar-fill.running{background:var(--accent);animation:pulse 1s infinite}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.5}}
.recommendation{background:#1b2a1b;border:1px solid var(--green);border-radius:6px;padding:10px;margin:6px 0;font-size:0.8em;white-space:pre-wrap}
.tabs{display:flex;gap:0;margin-bottom:12px;border-bottom:1px solid var(--border)}
.tab{padding:8px 16px;cursor:pointer;color:var(--text2);border-bottom:2px solid transparent;font-size:0.85em}
.tab.active{color:var(--accent);border-color:var(--accent)}
.tab-content{display:none}
.tab-content.active{display:block}
</style>
</head>
<body>
<h1>
  <span class="status" id="connStatus"></span>
  Research Lab â€” Counterfactual Engine
  <span style="font-size:0.7em;color:var(--text2);margin-left:auto" id="cycleInfo">cycle 0</span>
</h1>

<div class="tabs">
  <div class="tab active" onclick="switchTab('overview')">Overview</div>
  <div class="tab" onclick="switchTab('trace')">Research Trace</div>
  <div class="tab" onclick="switchTab('findings')">Findings</div>
  <div class="tab" onclick="switchTab('sweep')">Sweep Progress</div>
  <div class="tab" onclick="switchTab('mtf_imageh')">MTF ImageH</div>
  <div class="tab" onclick="switchTab('regime')">Regime Analysis</div>
  <div class="tab" onclick="switchTab('log')">Log</div>
</div>

<!-- TRACE TAB -->
<div class="tab-content" id="tab-trace">
  <div class="card">
    <h2>ğŸ§­ Research Progress & Applied Effects</h2>
    <div id="researchTrace"></div>
  </div>
</div>

<!-- OVERVIEW TAB -->
<div class="tab-content active" id="tab-overview">
  <div class="grid">
    <div class="card">
      <h2>ğŸ“Š Baseline Metrics (Current)</h2>
      <div id="baselineMetrics"></div>
    </div>
    <div class="card">
      <h2>ğŸ† Best CF Scenario</h2>
      <div id="bestCF"></div>
    </div>
  </div>
  <div class="card" style="margin-bottom:12px">
    <h2>ğŸ§ª Applied Performance (Auto-Apply)</h2>
    <div id="applyPerf"></div>
  </div>
  <div class="card">
    <h2>ğŸ”¬ Top Recommendations</h2>
    <div id="topRecommendations"></div>
  </div>
</div>

<!-- FINDINGS TAB -->
<div class="tab-content" id="tab-findings">
  <div class="card">
    <h2>ğŸ“‹ All Findings (sorted by impact)</h2>
    <div id="allFindings"></div>
  </div>
</div>

<!-- SWEEP PROGRESS TAB -->
<div class="tab-content" id="tab-sweep">
  <div class="card">
    <h2>âš¡ Parameter Sweep Progress</h2>
    <div id="sweepProgress"></div>
  </div>
</div>

<!-- MTF IMAGEH TAB -->
<div class="tab-content" id="tab-mtf_imageh">
  <div class="card" style="margin-bottom:12px">
    <h2>ğŸ“˜ MTF ì—”ì§„ ì„¤ëª…</h2>
    <div id="mtfGuide"></div>
  </div>
  <div class="grid">
    <div class="card">
      <h2>ğŸ§  Stage / Runtime ìƒíƒœ</h2>
      <div id="mtfSummary"></div>
    </div>
    <div class="card">
      <h2>ğŸ“¦ Artifacts</h2>
      <div id="mtfArtifacts"></div>
    </div>
  </div>
  <div class="grid">
    <div class="card">
      <h2>ğŸ—‚ ì…ë ¥ / ë°ì´í„° ë²”ìœ„</h2>
      <div id="mtfInput"></div>
    </div>
    <div class="card">
      <h2>ğŸ“Š ì ìˆ˜ ë¶„í¬ / ê²Œì´íŠ¸ í†µê³¼ìœ¨</h2>
      <div id="mtfScoreStats"></div>
    </div>
  </div>
  <div class="grid">
    <div class="card">
      <h2>ğŸ¯ Training / Validation</h2>
      <div id="mtfTraining"></div>
    </div>
    <div class="card">
      <h2>ğŸ“ˆ CF Best Gate</h2>
      <div id="mtfBest"></div>
    </div>
  </div>
  <div class="card" style="margin-bottom:12px">
    <h2>ğŸ§® Threshold Sweep ìš”ì•½</h2>
    <div id="mtfSweep"></div>
  </div>
  <div class="card" style="margin-bottom:12px">
    <h2>ğŸ§ª MTF Findings</h2>
    <div id="mtfFindings"></div>
  </div>
  <div class="card">
    <h2>âœ… Applied / Monitoring (MTF stage)</h2>
    <div id="mtfApply"></div>
  </div>
</div>

<!-- REGIME TAB -->
<div class="tab-content" id="tab-regime">
  <div class="card">
    <h2>ğŸ· Performance by Regime</h2>
    <div id="regimeTable"></div>
  </div>
</div>

<!-- LOG TAB -->
<div class="tab-content" id="tab-log">
  <div class="card">
    <h2>ğŸ“ Research Log</h2>
    <div id="log"></div>
  </div>
</div>

<script>
let ws = null;
let reconnectTimer = null;
let logLines = [];
const MAX_LOG = 200;

function switchTab(name) {
  document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
  document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
  event.target.classList.add('active');
  document.getElementById('tab-'+name).classList.add('active');
}

function connect() {
  const proto = location.protocol === 'https:' ? 'wss:' : 'ws:';
  ws = new WebSocket(`${proto}//${location.host}/ws`);
  ws.onopen = () => {
    document.getElementById('connStatus').classList.add('on');
    addLog('WebSocket connected');
  };
  ws.onclose = () => {
    document.getElementById('connStatus').classList.remove('on');
    if (!reconnectTimer) reconnectTimer = setTimeout(() => { reconnectTimer=null; connect(); }, 3000);
  };
  ws.onmessage = (e) => {
    try {
      const data = JSON.parse(e.data);
      if (data.type === 'heartbeat') return;
      render(data);
    } catch(err) { addLog('Parse error: '+err); }
  };
}

function render(data) {
  // Cycle info
  const ci = document.getElementById('cycleInfo');
  const done = Number(data.completed_cycles_total ?? data.cycle_count ?? 0);
  const current = Number(data.current_cycle_index ?? (data.running ? done + 1 : done));
  const stageNow = data.stage_current || '-';
  ci.textContent = `done ${done} | current #${current} ${data.running ? `âš¡ ${stageNow}` : 'â¸ idle'} | ${new Date((data.last_update_ts||0)*1000).toLocaleTimeString()}`;

  // Baseline
  const bl = data.baseline || {};
  const bm = document.getElementById('baselineMetrics');
  bm.innerHTML = metricChips(bl);

  // Best CF
  const findings = data.findings || data.top_10 || [];
  const bc = document.getElementById('bestCF');
  if (findings.length > 0) {
    const best = findings[0];
    bc.innerHTML = `
      <div class="finding">
        <div class="title">${esc(best.title)} <span class="badge ${best.confidence>=0.6?'high':best.confidence>=0.3?'med':'low'}">${(best.confidence*100).toFixed(0)}%</span></div>
        <div class="improvement ${best.improvement_pct>0?'pos':'neg'}">Î”PnL: $${best.improvement_pct>=0?'+':''}${best.improvement_pct.toFixed(2)}</div>
        <div class="detail">${esc(best.description||'')}</div>
      </div>`;
  } else {
    bc.innerHTML = '<span style="color:var(--text2)">No findings yet...</span>';
  }

  // Top recommendations
  const tr = document.getElementById('topRecommendations');
  const topN = findings.slice(0, 5);
  tr.innerHTML = topN.map(f => `
    <div class="recommendation">${esc(f.recommendation||'No recommendation')}</div>
  `).join('') || '<span style="color:var(--text2)">Waiting for sweep results...</span>';

  // Auto-apply performance
  const ap = document.getElementById('applyPerf');
  const history = Array.isArray(data.apply_history) ? data.apply_history : [];
  const auto = data.auto_apply || {};
  const monitoring = history.filter(h => h && h.status === 'monitoring');
  const applied = history.filter(h => h && h.status === 'applied');
  const rolled = history.filter(h => h && h.status === 'rolled_back');
  const finalized = history.filter(h => h && (h.status === 'applied' || h.status === 'rolled_back'));
  let avgDelta = null;
  if (finalized.length > 0) {
    const deltas = finalized
      .map(h => Number(h.equity_after_monitor) - Number(h.equity_at_apply))
      .filter(v => Number.isFinite(v));
    if (deltas.length) avgDelta = deltas.reduce((a,b)=>a+b,0) / deltas.length;
  }
  const histRows = history.slice().reverse().slice(0, 8);
  const fmtDelta = (h) => {
    const a = Number(h.equity_at_apply);
    const b = Number(h.equity_after_monitor);
    if (!Number.isFinite(a) || !Number.isFinite(b)) return '-';
    const d = b - a;
    const sign = d >= 0 ? '+' : '';
    return `${sign}$${d.toFixed(2)}`;
  };
  ap.innerHTML = `
    <div style="margin-bottom:8px">
      <span class="metric info">History=${history.length}</span>
      <span class="metric neutral">Monitoring=${monitoring.length}</span>
      <span class="metric good">Applied=${applied.length}</span>
      <span class="metric bad">RolledBack=${rolled.length}</span>
      <span class="metric ${avgDelta===null?'info':avgDelta>=0?'good':'bad'}">Avg Î”Eq=${avgDelta===null?'-':(avgDelta>=0?'+':'')+'$'+avgDelta.toFixed(2)}</span>
      <span class="metric info">LastAction=${esc(String(auto.last_action||'-'))}</span>
    </div>
    ${histRows.length ? `
      <table>
        <tr><th>Time</th><th>Finding</th><th>Stage</th><th>Status</th><th>Î”Equity</th></tr>
        ${histRows.map(h => `
          <tr>
            <td>${new Date((Number(h.timestamp)||0)*1000).toLocaleString()}</td>
            <td>${esc(h.finding_id||'-')}</td>
            <td>${esc(h.stage||'-')}</td>
            <td>${esc(h.status||'-')}</td>
            <td style="color:${(fmtDelta(h).startsWith('+')?'var(--green)':fmtDelta(h).startsWith('-')?'var(--red)':'var(--text2)')}">${fmtDelta(h)}</td>
          </tr>
        `).join('')}
      </table>
    ` : '<span style="color:var(--text2)">No apply history yet</span>'}
  `;

  // All findings
  const af = document.getElementById('allFindings');
  af.innerHTML = findings.map((f,i) => `
    <div class="finding">
      <div class="title">#${i+1} ${esc(f.title)} <span class="badge ${f.confidence>=0.6?'high':f.confidence>=0.3?'med':'low'}">${(f.confidence*100).toFixed(0)}%</span></div>
      <div class="improvement ${f.improvement_pct>0?'pos':'neg'}">Î”PnL: $${f.improvement_pct>=0?'+':''}${f.improvement_pct.toFixed(2)}</div>
      <div class="detail">${esc(f.description||'')}</div>
      <div class="recommendation" style="margin-top:6px">${esc(f.recommendation||'')}</div>
    </div>
  `).join('') || '<span style="color:var(--text2)">No findings</span>';

  // Sweep progress
  const sp = document.getElementById('sweepProgress');
  const progress = data.sweep_progress || {};
  sp.innerHTML = Object.entries(progress).map(([stage, info]) => {
    const pct = info.total > 0 ? (info.done / info.total * 100) : 0;
    const status = info.status || 'pending';
    return `<div class="sweep-stage">
      <span class="name">${esc(stage)}</span>
      <div class="bar"><div class="bar-fill ${status}" style="width:${pct}%"></div></div>
      <span>${info.done||0}/${info.total||0}</span>
    </div>`;
  }).join('') || '<span style="color:var(--text2)">Not started</span>';

  // MTF ImageH
  const mtf = data.mtf_imageh || {};
  const mtfStage = mtf.stage_progress || {};
  const mtfInputCfg = mtf.input || {};
  const mtfArtifactsCfg = mtf.artifacts || {};
  const mtfScore = mtf.score_stats || {};
  const mtfDataWindow = mtf.data_window || {};
  const mtfSweep = mtf.sweep || {};
  const sideThr = Number(mtf.runtime_env?.MTF_DL_ENTRY_MIN_SIDE_PROB || 0);
  const winThr = Number(mtf.runtime_env?.MTF_DL_ENTRY_MIN_WIN_PROB || 0);

  const mtfGuide = document.getElementById('mtfGuide');
  mtfGuide.innerHTML = `
    <div style="font-size:0.82em;line-height:1.55;color:var(--text2)">
      <div>MTF ì—”ì§„ì€ <b>ì¢…ê°€ ê¸°ë°˜ ì²´ê²° ì´ë ¥(trades)</b>ì—ì„œ EXIT í˜ì–´ë¥¼ ëª¨ì•„ í•™ìŠµí•˜ê³ , ê° íŠ¸ë ˆì´ë“œì˜ ì§„ì…ì‹œì  1ë¶„ë´‰ì„ ë©€í‹° íƒ€ì„í”„ë ˆì„ ì´ë¯¸ì§€(ì˜ˆ: 1/3/5/15ë¶„)ë¡œ ë³€í™˜í•´ í™•ë¥  ì ìˆ˜ë¥¼ ë§Œë“­ë‹ˆë‹¤.</div>
      <div style="margin-top:6px">ì—°êµ¬ ìŠ¤í…Œì´ì§€ëŠ” 5ë¶„ CF ì‚¬ì´í´ë§ˆë‹¤ ì‹¤í–‰ë˜ë©°, í˜„ì¬ ì‚¬ì´í´ì—ì„œ ìƒì„±ëœ ì ìˆ˜/ëª¨ë¸/ë¦¬í¬íŠ¸ë¥¼ ì•„ë˜ì— í‘œì‹œí•©ë‹ˆë‹¤.</div>
      <div style="margin-top:6px">ê²Œì´íŠ¸ í•´ì„: <code>mtf_dl_prob</code>ê°€ í˜„ì¬ ì„ê³„ì¹˜(side=${sideThr.toFixed(3)}, win=${winThr.toFixed(3)})ë¥¼ ì–¼ë§ˆë‚˜ í†µê³¼í•˜ëŠ”ì§€ ë¹„ìœ¨ë¡œ í™•ì¸í•˜ì„¸ìš”.</div>
    </div>
  `;

  const mtfSummary = document.getElementById('mtfSummary');
  mtfSummary.innerHTML = `
    <span class="metric info">stage=${esc(String(mtf.stage_name || 'mtf_image_dl_gate'))}</span>
    <span class="metric ${String(mtfStage.status||'').toLowerCase()==='done'?'good':String(mtfStage.status||'').toLowerCase()==='error'?'bad':'neutral'}">status=${esc(String(mtfStage.status || '-'))}</span>
    <span class="metric info">progress=${Number(mtfStage.done||0)}/${Number(mtfStage.total||0)}</span>
    <span class="metric ${mtf.runtime_env?.CF_MTF_DL_ENABLED ? 'good':'bad'}">CF_MTF_DL=${mtf.runtime_env?.CF_MTF_DL_ENABLED ? 'ON':'OFF'}</span>
    <span class="metric ${mtf.runtime_env?.MTF_DL_RUNTIME_ENABLED ? 'good':'bad'}">Runtime=${mtf.runtime_env?.MTF_DL_RUNTIME_ENABLED ? 'ON':'OFF'}</span>
    <span class="metric ${mtf.runtime_env?.MTF_DL_ENTRY_GATE_ENABLED ? 'good':'neutral'}">EntryGate=${mtf.runtime_env?.MTF_DL_ENTRY_GATE_ENABLED ? 'ON':'OFF'}</span>
    <span class="metric ${mtf.runtime_env?.MTF_DL_EXIT_HEAD_ENABLED ? 'good':'neutral'}">ExitHead=${mtf.runtime_env?.MTF_DL_EXIT_HEAD_ENABLED ? 'ON':'OFF'}</span>
    <span class="metric info">side_thr=${sideThr.toFixed(3)}</span>
    <span class="metric info">win_thr=${winThr.toFixed(3)}</span>
    <span class="metric ${Number(mtfScore.ratio_ge_side_threshold||0)>=0.2?'good':Number(mtfScore.ratio_ge_side_threshold||0)>=0.05?'neutral':'bad'}">pass_side=${(Number(mtfScore.ratio_ge_side_threshold||0)*100).toFixed(1)}%</span>
    <div style="margin-top:8px;color:var(--text2);font-size:0.78em">
      cycle=${Number(mtf.cycle_count||0)} | updated=${fmtTime((data.last_update_ts||0)*1000)}
    </div>
  `;

  const mtfArtifacts = document.getElementById('mtfArtifacts');
  const report = mtf.report || {};
  const model = mtf.model || {};
  const scores = mtf.scores || {};
  mtfArtifacts.innerHTML = `
    <table>
      <tr><th>Artifact</th><th>Path</th><th>Updated</th><th>Size</th></tr>
      <tr><td>report</td><td>${esc(String(report.path||'-'))}</td><td>${fmtTime((Number(report.mtime)||0)*1000)}</td><td>-</td></tr>
      <tr><td>model</td><td>${esc(String(model.path||'-'))}</td><td>${fmtTime((Number(model.mtime)||0)*1000)}</td><td>${fmtSize(model.size_bytes)}</td></tr>
      <tr><td>scores</td><td>${esc(String(scores.path||'-'))}</td><td>${fmtTime((Number(scores.mtime)||0)*1000)}</td><td>${fmtSize(scores.size_bytes)}</td></tr>
      <tr><td>model(out)</td><td>${esc(String(mtfArtifactsCfg.model_out||'-'))}</td><td>-</td><td>-</td></tr>
      <tr><td>scores(out)</td><td>${esc(String(mtfArtifactsCfg.scores_out||'-'))}</td><td>-</td><td>-</td></tr>
    </table>
  `;

  const mtfInput = document.getElementById('mtfInput');
  mtfInput.innerHTML = `
    <table>
      <tr><th>í•­ëª©</th><th>ê°’</th></tr>
      <tr><td>db</td><td>${esc(String(mtfInputCfg.db||'-'))}</td></tr>
      <tr><td>max_symbols</td><td>${Number(mtfInputCfg.max_symbols||0)}</td></tr>
      <tr><td>max_trades</td><td>${Number(mtfInputCfg.max_trades||0)}</td></tr>
      <tr><td>min_hold_sec</td><td>${Number(mtfInputCfg.min_hold_sec||0)}</td></tr>
      <tr><td>timeframes</td><td>${esc(JSON.stringify(mtfInputCfg.timeframes||[]))}</td></tr>
      <tr><td>lookback_bars</td><td>${Number(mtfInputCfg.lookback_bars||0)}</td></tr>
      <tr><td>train_ratio</td><td>${Number(mtfInputCfg.train_ratio||0).toFixed(2)}</td></tr>
      <tr><td>epochs / batch</td><td>${Number(mtfInputCfg.epochs||0)} / ${Number(mtfInputCfg.batch_size||0)}</td></tr>
      <tr><td>excluded_symbols</td><td>${esc((mtfInputCfg.excluded_symbols||[]).join(', ') || '-')}</td></tr>
      <tr><td>entry_window_start</td><td>${fmtTime(Number(mtfDataWindow.entry_ts_min_ms||0))}</td></tr>
      <tr><td>entry_window_end</td><td>${fmtTime(Number(mtfDataWindow.entry_ts_max_ms||0))}</td></tr>
      <tr><td>entry_span_hours</td><td>${Number(mtfDataWindow.entry_span_hours||0).toFixed(1)}h</td></tr>
      <tr><td>cf_eval_start</td><td>${fmtTime(Number(mtfDataWindow.cf_eval_start_ts_ms||0))}</td></tr>
    </table>
  `;

  const mtfScoreStats = document.getElementById('mtfScoreStats');
  mtfScoreStats.innerHTML = `
    <span class="metric info">n_scores=${Number(mtfScore.n_scores||0)}</span>
    <span class="metric info">prob_min=${Number(mtfScore.prob_min||0).toFixed(4)}</span>
    <span class="metric info">prob_max=${Number(mtfScore.prob_max||0).toFixed(4)}</span>
    <span class="metric info">prob_mean=${Number(mtfScore.prob_mean||0).toFixed(4)}</span>
    <span class="metric ${Number(mtfScore.ratio_ge_side_threshold||0)>=0.2?'good':Number(mtfScore.ratio_ge_side_threshold||0)>=0.05?'neutral':'bad'}">>=side_thr ${Number(mtfScore.n_ge_side_threshold||0)} (${(Number(mtfScore.ratio_ge_side_threshold||0)*100).toFixed(1)}%)</span>
    <span class="metric ${Number(mtfScore.ratio_ge_win_threshold||0)>=0.2?'good':Number(mtfScore.ratio_ge_win_threshold||0)>=0.05?'neutral':'bad'}">>=win_thr ${Number(mtfScore.n_ge_win_threshold||0)} (${(Number(mtfScore.ratio_ge_win_threshold||0)*100).toFixed(1)}%)</span>
  `;

  const mtfTraining = document.getElementById('mtfTraining');
  const ds = mtf.dataset || {};
  const trn = mtf.training || {};
  mtfTraining.innerHTML = `
    <span class="metric info">samples=${Number(ds.n_samples_built||0)}</span>
    <span class="metric info">train=${Number(ds.n_train||0)}</span>
    <span class="metric info">val=${Number(ds.n_val||0)}</span>
    <span class="metric ${Number(trn.val_side_auc_last||0)>=0.55?'good':Number(trn.val_side_auc_last||0)>=0.50?'neutral':'bad'}">val_side_auc=${Number(trn.val_side_auc_last||0).toFixed(4)}</span>
    <span class="metric ${Number(trn.val_win_auc_last||0)>=0.55?'good':Number(trn.val_win_auc_last||0)>=0.50?'neutral':'bad'}">val_win_auc=${Number(trn.val_win_auc_last||0).toFixed(4)}</span>
    <span class="metric neutral">val_hold_mae=${Number(trn.val_hold_mae_last||0).toFixed(1)}s</span>
    <span class="metric neutral">val_exit_acc=${Number(trn.val_exit_acc_last||0).toFixed(3)}</span>
    <div style="margin-top:8px;color:var(--text2);font-size:0.78em">
      eval_side_auc=${Number(trn.eval_side_auc||0).toFixed(4)} | eval_win_auc=${Number(trn.eval_win_auc||0).toFixed(4)} | trades_loaded=${Number(ds.n_trades_loaded||0)} | skipped=${Number(ds.n_skipped||0)}
    </div>
    <div style="margin-top:6px;color:var(--text2);font-size:0.78em">
      symbols=${esc((ds.symbols_used||[]).join(', ') || '-')}
    </div>
  `;

  const mtfBest = document.getElementById('mtfBest');
  const best = mtf.best || {};
  const baseM = (mtf.baseline||{}).all || {};
  const bg = best.global_gate || {};
  const bgq = best.global_gate_quantile || {};
  const bcq = best.chop_only_gate_quantile || {};
  mtfBest.innerHTML = `
    <div style="margin-bottom:8px;color:var(--text2);font-size:0.78em">
      baseline(all): n=${Number(baseM.n||0)} pnl=${Number(baseM.pnl||0).toFixed(2)} wr=${(Number(baseM.wr||0)*100).toFixed(1)}%
    </div>
    <table>
      <tr><th>Mode</th><th>Thr/Q</th><th>N</th><th>PnL</th><th>WR</th></tr>
      <tr><td>global</td><td>${Number(bg.threshold||0).toFixed(2)}</td><td>${Number(bg.n||0)}</td><td style="color:${Number(bg.pnl||0)>=0?'var(--green)':'var(--red)'}">${Number(bg.pnl||0).toFixed(2)}</td><td>${(Number(bg.wr||0)*100).toFixed(1)}%</td></tr>
      <tr><td>global_q</td><td>q=${Number(bgq.quantile||0).toFixed(2)} / ${Number(bgq.threshold||0).toFixed(2)}</td><td>${Number(bgq.n||0)}</td><td style="color:${Number(bgq.pnl||0)>=0?'var(--green)':'var(--red)'}">${Number(bgq.pnl||0).toFixed(2)}</td><td>${(Number(bgq.wr||0)*100).toFixed(1)}%</td></tr>
      <tr><td>chop_q</td><td>q=${Number(bcq.quantile||0).toFixed(2)} / ${Number(bcq.threshold||0).toFixed(2)}</td><td>${Number(bcq.n||0)}</td><td style="color:${Number(bcq.pnl||0)>=0?'var(--green)':'var(--red)'}">${Number(bcq.pnl||0).toFixed(2)}</td><td>${(Number(bcq.wr||0)*100).toFixed(1)}%</td></tr>
    </table>
  `;

  const mtfSweepEl = document.getElementById('mtfSweep');
  const rowsG = Array.isArray(mtfSweep.global_gate) ? mtfSweep.global_gate : [];
  const rowsGQ = Array.isArray(mtfSweep.global_gate_quantile) ? mtfSweep.global_gate_quantile : [];
  const rowsCQ = Array.isArray(mtfSweep.chop_only_gate_quantile) ? mtfSweep.chop_only_gate_quantile : [];
  const topByPnl = (rows) => rows.slice().sort((a,b)=>Number(b.pnl||0)-Number(a.pnl||0)).slice(0,3);
  const gTop = topByPnl(rowsG);
  const gqTop = topByPnl(rowsGQ);
  const cqTop = topByPnl(rowsCQ);
  mtfSweepEl.innerHTML = `
    <table>
      <tr><th>bucket</th><th>rank</th><th>thr/q</th><th>n</th><th>pnl</th><th>wr</th><th>pf</th></tr>
      ${gTop.map((r,i)=>`<tr><td>global</td><td>#${i+1}</td><td>${Number(r.threshold||0).toFixed(3)}</td><td>${Number(r.n||0)}</td><td style="color:${Number(r.pnl||0)>=0?'var(--green)':'var(--red)'}">${Number(r.pnl||0).toFixed(2)}</td><td>${(Number(r.wr||0)*100).toFixed(1)}%</td><td>${Number(r.pf||0).toFixed(2)}</td></tr>`).join('')}
      ${gqTop.map((r,i)=>`<tr><td>global_q</td><td>#${i+1}</td><td>q=${Number(r.quantile||0).toFixed(2)} / ${Number(r.threshold||0).toFixed(3)}</td><td>${Number(r.n||0)}</td><td style="color:${Number(r.pnl||0)>=0?'var(--green)':'var(--red)'}">${Number(r.pnl||0).toFixed(2)}</td><td>${(Number(r.wr||0)*100).toFixed(1)}%</td><td>${Number(r.pf||0).toFixed(2)}</td></tr>`).join('')}
      ${cqTop.map((r,i)=>`<tr><td>chop_q</td><td>#${i+1}</td><td>q=${Number(r.quantile||0).toFixed(2)} / ${Number(r.threshold||0).toFixed(3)}</td><td>${Number(r.n||0)}</td><td style="color:${Number(r.pnl||0)>=0?'var(--green)':'var(--red)'}">${Number(r.pnl||0).toFixed(2)}</td><td>${(Number(r.wr||0)*100).toFixed(1)}%</td><td>${Number(r.pf||0).toFixed(2)}</td></tr>`).join('')}
    </table>
  `;

  const mtfFindings = document.getElementById('mtfFindings');
  const mtfF = Array.isArray(mtf.mtf_findings) ? mtf.mtf_findings : [];
  mtfFindings.innerHTML = mtfF.map((f, i) => `
    <div class="finding">
      <div class="title">#${i+1} ${esc(String(f.title||'-'))}</div>
      <div class="improvement ${Number(f.improvement_pct||0)>=0?'pos':'neg'}">Î”PnL: ${Number(f.improvement_pct||0).toFixed(2)} | conf ${(Number(f.confidence||0)*100).toFixed(0)}%</div>
      <div class="detail">${esc(String(f.recommendation||''))}</div>
    </div>
  `).join('') || '<span style="color:var(--text2)">No MTF-stage findings in this cycle.</span>';

  const mtfApply = document.getElementById('mtfApply');
  const ah = Array.isArray(mtf.mtf_apply_history) ? mtf.mtf_apply_history : [];
  mtfApply.innerHTML = ah.length ? `
    <table>
      <tr><th>Time</th><th>Finding</th><th>Status</th><th>Î”Equity</th><th>Rollback</th></tr>
      ${ah.slice(0, 12).map(h => {
        const a = Number(h.equity_at_apply), b = Number(h.equity_after_monitor);
        const d = (Number.isFinite(a) && Number.isFinite(b)) ? (b-a) : null;
        const dTxt = d===null ? '-' : `${d>=0?'+':''}$${d.toFixed(2)}`;
        const dColor = d===null ? 'var(--text2)' : (d>=0?'var(--green)':'var(--red)');
        return `<tr>
          <td>${fmtTime((Number(h.timestamp)||0)*1000)}</td>
          <td>${esc(String(h.finding_id||'-'))}</td>
          <td>${esc(String(h.status||'-'))}</td>
          <td style="color:${dColor}">${dTxt}</td>
          <td>${h.rolled_back ? 'Y' : 'N'} ${h.rollback_reason ? `(${esc(String(h.rollback_reason))})` : ''}</td>
        </tr>`;
      }).join('')}
    </table>
  ` : '<span style="color:var(--text2)">No MTF apply history yet.</span>';

  // Regime
  const rt = document.getElementById('regimeTable');
  const byRegime = data.baseline_by_regime || {};
  let rtHtml = '<table><tr><th>Regime</th><th>N</th><th>PnL</th><th>WR</th><th>R:R</th><th>Edge</th><th>Sharpe</th></tr>';
  for (const [regime, m] of Object.entries(byRegime)) {
    rtHtml += `<tr>
      <td><span class="regime-chip ${regime}">${regime}</span></td>
      <td>${m.n}</td>
      <td style="color:${m.pnl>=0?'var(--green)':'var(--red)'}">${m.pnl>=0?'+':''}$${m.pnl.toFixed(2)}</td>
      <td>${(m.wr*100).toFixed(1)}%</td>
      <td>${m.rr.toFixed(2)}</td>
      <td style="color:${m.edge>=0?'var(--green)':'var(--red)'}">${(m.edge*100).toFixed(1)}pp</td>
      <td>${m.sharpe.toFixed(2)}</td>
    </tr>`;
  }
  rtHtml += '</table>';
  rt.innerHTML = rtHtml;

  // Research trace (cycle-level proposal/apply/effect)
  const traceEl = document.getElementById('researchTrace');
  const cycles = Array.isArray(data.research_cycles) ? data.research_cycles.slice().reverse() : [];
  if (!cycles.length) {
    traceEl.innerHTML = '<span style="color:var(--text2)">No research cycle history yet...</span>';
  } else {
    const rows = cycles.map(c => {
      const sugg = Array.isArray(c.suggestions) ? c.suggestions : [];
      const suggRows = sugg.slice(0, 12).map(s => {
        const finalDelta = Number(s.effect_delta_equity_final);
        const liveDelta = Number(s.effect_delta_equity_live);
        let effTxt = '-';
        let effColor = 'var(--text2)';
        if (Number.isFinite(finalDelta)) {
          effTxt = `${finalDelta >= 0 ? '+' : ''}$${finalDelta.toFixed(2)} (final)`;
          effColor = finalDelta >= 0 ? 'var(--green)' : 'var(--red)';
        } else if (Number.isFinite(liveDelta)) {
          effTxt = `${liveDelta >= 0 ? '+' : ''}$${liveDelta.toFixed(2)} (live)`;
          effColor = liveDelta >= 0 ? 'var(--green)' : 'var(--red)';
        }
        return `<tr>
          <td>${esc(String(s.finding_id||'-'))}</td>
          <td>${esc(String(s.stage||'-'))}</td>
          <td>${esc(String(s.title||'-'))}</td>
          <td>${(Number(s.improvement_pct)||0).toFixed(2)}</td>
          <td>${(Number(s.confidence||0)*100).toFixed(0)}%</td>
          <td>${s.applied ? 'Y' : 'N'} (${esc(String(s.apply_state||'not_applied'))})</td>
          <td style="color:${effColor}">${effTxt}</td>
        </tr>`;
      }).join('');
      const avgEff = Number(c.avg_effect_delta_equity);
      const avgTxt = Number.isFinite(avgEff) ? `${avgEff >= 0 ? '+' : ''}$${avgEff.toFixed(2)}` : '-';
      const avgCls = Number.isFinite(avgEff) ? (avgEff >= 0 ? 'good' : 'bad') : 'info';
      return `
        <div class="finding" style="margin-bottom:10px">
          <div class="title">#${Number(c.cycle_index)||0} | status=${esc(String(c.status||'-'))} | elapsed=${Number(c.elapsed_sec||0).toFixed(1)}s</div>
          <div style="margin-bottom:6px">
            <span class="metric info">findings=${Number(c.n_findings||0)}</span>
            <span class="metric good">applied=${Number(c.applied_n||0)}</span>
            <span class="metric neutral">monitoring=${Number(c.monitoring_n||0)}</span>
            <span class="metric bad">rolled_back=${Number(c.rolled_back_n||0)}</span>
            <span class="metric ${avgCls}">avg Î”Eq=${avgTxt}</span>
            <span class="metric info">started=${new Date((Number(c.started_ts)||0)*1000).toLocaleString()}</span>
          </div>
          <table>
            <tr><th>FindingID</th><th>Stage</th><th>Title</th><th>Î”PnL</th><th>Conf</th><th>Applied</th><th>Observed Effect</th></tr>
            ${suggRows || '<tr><td colspan="7" style="color:var(--text2)">No suggestions</td></tr>'}
          </table>
        </div>
      `;
    }).join('');
    traceEl.innerHTML = rows;
  }
}

function metricChips(m) {
  if (!m || !m.n) return '<span style="color:var(--text2)">Loading...</span>';
  return `
    <span class="metric info">N=${m.n}</span>
    <span class="metric ${m.pnl>=0?'good':'bad'}">PnL=$${m.pnl>=0?'+':''}${m.pnl.toFixed(2)}</span>
    <span class="metric ${m.wr>=0.5?'good':m.wr>=0.4?'neutral':'bad'}">WR=${(m.wr*100).toFixed(1)}%</span>
    <span class="metric ${m.rr>=1?'good':m.rr>=0.5?'neutral':'bad'}">R:R=${m.rr.toFixed(2)}</span>
    <span class="metric ${m.edge>=0?'good':'bad'}">Edge=${(m.edge*100).toFixed(1)}pp</span>
    <span class="metric ${m.sharpe>=1?'good':m.sharpe>=0?'neutral':'bad'}">Sharpe=${m.sharpe.toFixed(2)}</span>
    <span class="metric ${m.pf>=1?'good':'bad'}">PF=${m.pf.toFixed(2)}</span>
    <span class="metric bad">MaxDD=$${m.max_dd.toFixed(2)}</span>
  `;
}

function addLog(msg) {
  logLines.push(`[${new Date().toLocaleTimeString()}] ${msg}`);
  if (logLines.length > MAX_LOG) logLines.shift();
  const el = document.getElementById('log');
  el.innerHTML = logLines.map(l => `<div>${esc(l)}</div>`).join('');
  el.scrollTop = el.scrollHeight;
}

function esc(s) { const d=document.createElement('div'); d.textContent=s||''; return d.innerHTML; }
function fmtTime(ms) {
  const n = Number(ms || 0);
  if (!Number.isFinite(n) || n <= 0) return '-';
  return new Date(n).toLocaleString();
}
function fmtSize(bytes) {
  const b = Number(bytes || 0);
  if (!Number.isFinite(b) || b <= 0) return '-';
  if (b < 1024) return `${b.toFixed(0)} B`;
  if (b < 1024 * 1024) return `${(b / 1024).toFixed(1)} KB`;
  return `${(b / (1024 * 1024)).toFixed(2)} MB`;
}

connect();
</script>
</body>
</html>
