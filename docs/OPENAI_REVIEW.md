# OpenAI Code Review — 2026-02-18 08:04

**Model:** gpt-4.1-mini
**Risk Score:** 7/10
**Summary:** 코드 전반적으로 레짐별 정책과 MC 기반 진입/청산 의사결정이 체계적으로 구성되어 있으나, 일부 비용 이중 차감과 레버리지 하한/상한 설정, 필터 임계치 조정이 필요하며, 메모리 관리 및 성능 최적화 여지가 존재합니다.

## Suggestions

### [P1] EV 계산 시 비용 이중 차감 문제 개선
**Category:** logic | **Confidence:** 90%

evaluate_entry_metrics 함수에서 MC 시뮬레이션 결과 EV는 이미 거래 비용이 차감된 값임에도 불구하고, _min_filter_states 등 하류 필터에서 다시 비용을 차감하여 net_edge를 계산하는 로직이 존재함. 이중 차감으로 인해 진입 신호가 과도하게 약화되어 진입 기회 손실 및 과도한 보수적 판단이 발생할 수 있음. 비용 차감 방식을 명확히 하여 EV는 순수 기대수익으로 유지하고, 필터에서 비용 차감 여부를 일관되게 처리해야 함.

**Code Changes:** engines/mc/entry_evaluation.py 및 관련 필터 로직에서 EV와 비용 처리 부분을 점검하여, EV가 이미 비용 차감된 값인지 명확히 하고, net_edge 계산 시 비용을 중복 차감하지 않도록 수정 필요.

**Expected Impact:** 진입 신호의 왜곡 감소, 필터 통과율 개선, 전체 전략 수익성 향상

### [P1] 레버리지 하한 및 상한 환경변수 재조정
**Category:** param | **Confidence:** 85%

현재 bybit.env에서 UNI_LEV_MIN=10.0, UNI_LEV_MAX=50 등 매우 공격적인 레버리지 범위를 사용 중임. CF 분석 결과 2~10 구간에서 최대 손실 구간이 발견되어 최소 레버리지를 10으로 설정한 것은 위험할 수 있음. 레버리지 하한을 낮추고, 레짐별 상한을 현실적인 수준(예: bull 20, bear 12, chop 6 등)으로 조정하여 리스크를 줄이는 것이 바람직함.

**Env Changes:** `{'UNI_LEV_MIN': '1.0', 'UNI_LEV_MAX': '20', 'UNI_LEV_MAX_BEAR': '12', 'UNI_LEV_MAX_CHOP': '6', 'UNI_LEV_MAX_VOLATILE': '4'}`

**Code Changes:** engines/mc/config.py 및 regime_policy.py에서 레버리지 관련 기본값과 env 변수 적용 로직을 점검 및 조정.

**Expected Impact:** 과도한 레버리지에 따른 청산 위험 감소, 안정적인 포지션 운영 가능

### [P1] 레짐별 진입 필터 및 방향 차단 강화
**Category:** risk | **Confidence:** 90%

CF 분석 결과 bear_long, bull_short, chop_long 등 특정 레짐-방향 조합에서 손실이 지속되어 regime_side_block_list에 해당 조합을 추가하는 것이 수익성 개선에 효과적임. 또한 VPIN 필터(max_vpin=0.3)와 volatility_gate 필터를 강화하여 변동성 및 시장 충격에 따른 진입을 제한하는 것이 리스크 관리에 중요함.

**Env Changes:** `{'REGIME_SIDE_BLOCK_LIST': 'bear_long,bull_short,chop_long', 'MAX_VPIN': '0.3', 'CHOP_VOL_GATE_MIN_SIGMA': '0.1', 'CHOP_VOL_GATE_MAX_SIGMA': '0.8', 'CHOP_VOL_GATE_MAX_VPIN': '0.65', 'CHOP_VOL_GATE_MIN_DIR_CONF': '0.64', 'CHOP_ENTRY_FLOOR_ADD': '0.005', 'CHOP_ENTRY_MIN_DIR_CONF': '0.8'}`

**Code Changes:** engines/mc/regime_policy.py에서 regime_side_block 처리 강화 및 entry_evaluation.py에서 VPIN, volatility_gate 필터 적용 로직 점검.

**Expected Impact:** 비효율적 진입 감소, 리스크 조정된 진입으로 손실 최소화 및 수익성 개선

### [P2] 메모리 관리 및 GPU 활용 최적화
**Category:** perf | **Confidence:** 75%

evaluate_entry_metrics 등 MC 시뮬레이션 후 대형 배열 및 텐서 해제를 명시적으로 수행하고 있으나, 일부 예외 처리 및 캐시 비우기 로직이 완벽하지 않아 메모리 누수가 발생할 수 있음. 또한 GPU 가속 옵션이 환경변수에 따라 동적으로 활성화되나, 실패 시 fallback이 다소 무거울 수 있어 초기 로딩 시점에 명확한 상태 관리가 필요함.

**Code Changes:** engines/mc/entry_evaluation.py 및 decision.py에서 메모리 해제 및 GPU 초기화 로직 강화. 불필요한 변수 참조 제거 및 gc.collect 호출 위치 최적화.

**Expected Impact:** 메모리 누수 감소, 장기 운용 안정성 향상, GPU 활용 효율 개선

### [P2] 진입/청산 의사결정 로직 내 hybrid_only 플래그 명확화
**Category:** logic | **Confidence:** 70%

decision.py에서 hybrid_only 플래그가 환경변수 및 config에 따라 결정되는데, 이 플래그가 True일 경우 기존 로직과 완전히 분리되어 동작함. 다중 환경에서 혼란을 줄이기 위해 hybrid_only 모드와 기존 모드 간 경계 및 전환 조건을 명확히 문서화하고, config 기본값과 env 변수 간 불일치 가능성을 줄여야 함.

**Code Changes:** engines/mc/decision.py에서 hybrid_only 관련 조건문 정리 및 config.py에서 기본값 일관성 유지. 관련 주석 보강 및 예외 처리 추가.

**Expected Impact:** 의사결정 로직의 예측 가능성 향상, 디버깅 용이성 증가

### [P3] TP/SL 및 최대 보유 시간 환경변수 재검토
**Category:** param | **Confidence:** 60%

현재 bybit.env에서 POLICY_MAX_HOLD_SEC=1800(30분), DEFAULT_TP_PCT=0.04, DEFAULT_SL_PCT=0.005 등으로 설정되어 있음. CF 결과 장기 보유 시 손실 누적이 관찰되어 최대 보유 시간을 짧게 유지하는 것은 타당하나, TP/SL 비율은 시장 변동성 및 레짐별 특성에 맞게 동적으로 조정하는 방안도 고려 필요.

**Code Changes:** engines/mc/regime_policy.py에서 변동성 정규화 기반 TP/SL 스케일링 로직 점검 및 필요시 동적 조정 기능 추가 검토.

**Expected Impact:** 시장 상황에 맞는 TP/SL 조정으로 수익성 및 리스크 균형 개선

## Warnings
- EV 계산 시 비용 이중 차감 문제로 인해 진입 신호가 과도하게 약화될 수 있으므로 반드시 점검 필요.
- 과도한 레버리지 설정은 청산 위험을 높일 수 있으므로 보수적 조정 권장.
- 환경변수에 의존하는 설정이 많아, 운영 시 env 파일과 실제 적용 값 간 불일치에 주의해야 함.
- 메모리 해제 및 GPU 캐시 초기화 로직이 완벽하지 않을 경우 장기 운용 중 메모리 누수 발생 가능.
- 진입/청산 hybrid_only 모드 전환 시 기존 로직과의 충돌 가능성에 유의.


---
*Auto-generated by research/openai_reviewer.py*